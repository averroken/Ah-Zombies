<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Multiplayer</title>
</head>

<body>
    <div id="signDiv">
        Username: <input type="text" id="signDiv-username"><br/> Password: <input type="password" id="signDiv-password">
        <button id="signDiv-signIn">Sign In</button>
        <button id="signDiv-signUp">Sign Up</button>
    </div>


    <div id="gameDiv" style="display: none;">
        <canvas id="ctx" width="500" height="500" style="position:absolute; top:8px; left:8px; border:1px solid #000;"></canvas>
        <canvas id="ctx-ui" width="500" height="500" style="position:absolute; top:8px; left:8px; border:1px solid #000;"></canvas>

        <div id="chat-text" style="margin-top:500px; width: 500px; height: 100px; overflow-y: scroll; border: 1px solid #c2c2c2;">
            <ul id="chat-list" style="list-style: none; padding-left: 10px;"></ul>
        </div>

        <form action="#" id="chat-form">
            <input type="text" id="chat-input" style="width: 500px">
        </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();
        var TILE_SIZE = 32;
        var wall = false;
        var changed = false;
        var keyRight = false,
            keyLeft = false,
            keyUp = false,
            keyDown = false;

        //sign in
        var signDiv = document.getElementById('signDiv'),
            signDivUsername = document.getElementById('signDiv-username'),
            signDivPassword = document.getElementById('signDiv-password'),
            signDivSignIn = document.getElementById('signDiv-signIn'),
            signDivSignUp = document.getElementById('signDiv-signUp'),
            gameDiv = document.getElementById('gameDiv');

        signDivSignIn.addEventListener('click', function() {
            socket.emit('signIn', {
                username: signDivUsername.value,
                password: signDivPassword.value
            });
        });

        signDivSignUp.addEventListener('click', function() {
            socket.emit('signUp', {
                username: signDivUsername.value,
                password: signDivPassword.value
            });
        });

        socket.on('signInResponse', function(data) {
            if (data.success) {
                signDiv.style.display = 'none';
                gameDiv.style.display = 'inline-block';
            } else {
                alert('Sign in unsuccessful.');
            }
        });

        socket.on('signUpResponse', function(data) {
            if (data.success) {
                alert('Sign up successful.');
            } else {
                alert('Sign up unsuccessful.');
            }
        });


        //game
        var chatText = document.getElementById('chat-text'),
            chatList = document.getElementById('chat-list'),
            chatInput = document.getElementById('chat-input'),
            chatForm = document.getElementById('chat-form'),
            ctx = document.getElementById("ctx").getContext("2d"),
            ctxUi = document.getElementById("ctx-ui").getContext("2d"),
            selfId = null,
            WIDTH = 500,
            HEIGHT = 500;

        var Img = {};
        Img.player = new Image();
        Img.player.src = '/client/img/player.png';
        Img.bullet = new Image();
        Img.bullet.src = '/client/img/bullet.png';

        Img.map = {};
        Img.map['field'] = new Image();
        Img.map['field'].src = '/client/img/map.png';
        Img.map['forest'] = new Image();
        Img.map['forest'].src = '/client/img/map2.png';
        Img.map['collision'] = new Image();
        Img.map['collision'].src = '/client/img/map3.png';


        ctx.font = "30px Arial";


        var Player = function(initPack) {
            var self = {};
            self.id = initPack.id;
            self.number = initPack.number;
            self.x = initPack.x;
            self.y = initPack.y;
            self.hp = initPack.hp;
            self.hpMax = initPack.hpMax;
            self.score = initPack.score;
            self.map = initPack.map;

            self.draw = function() {
                if (Player.list[selfId].map !== self.map) return;

                var x = self.x - Player.list[selfId].x + WIDTH / 2;
                var y = self.y - Player.list[selfId].y + HEIGHT / 2;

                var hpWidth = 30 * self.hp / self.hpMax;
                ctx.fillStyle = 'red';
                ctx.fillRect(x - hpWidth / 2, y - 40, hpWidth, 4);

                var width = Img.player.width * 2;
                var height = Img.player.height * 2;



                ctx.drawImage(Img.player, 0, 0, Img.player.width, Img.player.height, x - width / 2, y - height / 2,
                    width * 1.5, height * 1.5);

                //            ctx.fillText(self.score, self.x, self.y-60);

                if (doesPlayerTouchWall(self)) {
                    // if (changed) {
                    if (wall) changed = false;
                    else changed = true;
                    wall = true;
                    if (changed) {
                        console.log('user hit wall');
                        socket.emit('wall', {
                            wall: true,
                            x: self.x,
                            y: self.y
                        })
                    }
                } else {
                    if (wall) changed = true;
                    else changed = false;
                    wall = false;
                    if (changed) {
                        console.log("user doesn't hit wall");
                        socket.emit('wall', {
                            wall: false
                        })
                    }
                }
                // }
            };

            Player.list[self.id] = self;
            return self;
        };
        Player.list = {};


        var Bullet = function(initPack) {
            var self = {};
            self.id = initPack.id;
            self.x = initPack.x;
            self.y = initPack.y;
            self.map = initPack.map;

            self.draw = function() {
                if (Player.list[selfId].map !== self.map) return;

                var width = Img.bullet.width / 2;
                var height = Img.bullet.height / 2;

                var x = self.x - Player.list[selfId].x + WIDTH / 2;
                var y = self.y - Player.list[selfId].y + HEIGHT / 2;

                ctx.drawImage(Img.bullet, 0, 0, Img.bullet.width, Img.bullet.height, x - width / 2, y - height / 2,
                    width, height);

                if (isPositionWall(self)) {
                    console.log('position is wall');
                    delete Bullet.list[self.id];
                }
            };

            Bullet.list[self.id] = self;
            return self;
        };
        Bullet.list = {};


        //init
        socket.on('init', function(data) {
            if (data.selfId) {
                selfId = data.selfId;
            }
            for (var i = 0; i < data.player.length; i++) {
                new Player(data.player[i]);
            }
            for (var i = 0; i < data.bullet.length; i++) {
                new Bullet(data.bullet[i]);
            }
        });

        //update
        socket.on('update', function(data) {
            for (var i = 0; i < data.player.length; i++) {
                var pack = data.player[i];
                var p = Player.list[pack.id];
                if (p) {
                    if (pack.x !== undefined) {
                        p.x = pack.x;
                    }
                    if (pack.y !== undefined) {
                        p.y = pack.y;
                    }
                    if (pack.hp !== undefined) {
                        p.hp = pack.hp;
                    }
                    if (pack.score !== undefined) {
                        p.score = pack.score;
                    }
                }
            }

            for (var i = 0; i < data.bullet.length; i++) {
                var pack = data.bullet[i];
                var b = Bullet.list[pack.id];
                if (b) {
                    if (pack.x !== undefined) {
                        b.x = pack.x;
                    }
                    if (pack.y !== undefined) {
                        b.y = pack.y;
                    }
                }
            }
        });

        //remove
        socket.on('remove', function(data) {
            for (var i = 0; i < data.player.length; i++) {
                delete Player.list[data.player[i]];
            }
            for (var i = 0; i < data.bullet.length; i++) {
                delete Bullet.list[data.bullet[i]];
            }
        });


        setInterval(function() {
            if (!selfId) return;
            ctx.clearRect(0, 0, 500, 500);
            drawMap();
            drawScore();
            for (var i in Player.list) {
                Player.list[i].draw();
            }
            for (var i in Bullet.list) {
                Bullet.list[i].draw();
            }
        }, 40);

        var drawMap = function() {
            var player = Player.list[selfId];
            var x = WIDTH / 2 - player.x;
            var y = HEIGHT / 2 - player.y;
            // ctx.drawImage(Img.map[player.map], x, y);
            var map = Img.map[player.map];
            ctx.drawImage(map, 0, 0, map.width, map.height, x, y, map.width * 2, map.height * 2);
        };

        var array = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502,
            502, 502,
            502, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 502,
            502, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502,
            502, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502, 502, 502, 0, 0, 0, 0, 0, 0,
            0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502, 502, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502,
            502,
            502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502, 502, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0,
            0, 0, 0, 0, 502, 502, 502, 502, 502, 0, 0, 0, 0, 0, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            502,
            502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502, 502, 502, 502, 502, 502, 502, 502, 0, 0,
            0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502, 502, 502, 502, 502, 502, 502, 502, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502,
            502, 502,
            502, 502, 502, 502, 502, 502, 502, 502, 502, 0, 0, 0, 0, 0, 0, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 0, 0, 0, 0, 0, 502, 502, 502, 502, 502, 502, 502, 502, 502, 502, 502, 502, 502, 0, 0, 0, 0, 0, 0, 502, 502,
            0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 0, 0, 0, 0, 0, 502, 502, 502, 502, 502, 502, 502, 502, 502, 502, 502, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502, 502,
            502,
            502, 502, 502, 502, 502, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502, 502, 502, 502, 502, 502, 502, 502, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502,
            502,
            502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502, 502, 502, 502, 502, 502, 502, 502, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502, 502, 502,
            502,
            502, 502, 502, 502, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502, 502, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502,
            0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502, 502, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 502, 502, 502, 502, 502, 0, 0, 0, 0,
            0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0,
            0, 0, 0, 0, 0, 0, 0, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            502,
            502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 502, 502, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0
        ];

        var array2D = [];
        for (var i = 0; i < 40; i++) {
            array2D[i] = [];
            for (var j = 0; j < 40; j++) {
                array2D[i][j] = array[i * 40 + j];
            }
        }

        function isPositionWall(pt) {
            var gridX = Math.floor(pt.x / TILE_SIZE);
            var gridY = Math.floor(pt.y / TILE_SIZE);
            if (gridX < 0 ||  gridX >= array2D[0].length) return true;
            if (gridY < 0 ||  gridY >= array2D.length) return true;
            return array2D[gridY][gridX];
        }

        function doesPlayerTouchWall(player) {
            var leftBumper = {
                x: player.x - 40,
                y: player.y
            };
            var rightBumper = {
                x: player.x + 40,
                y: player.y
            };
            var upBumper = {
                x: player.x,
                y: player.y - 16
            };
            var downBumper = {
                x: player.x,
                y: player.y + 64
            };

            if (isPositionWall(leftBumper)) {
                return true;
                console.log('leftBumper');
            }
            if (isPositionWall(rightBumper)) {
                return true;
                console.log('rightBumper');
            }
            if (isPositionWall(upBumper)) {
                return true;
                console.log('upBumper');
            }
            if (isPositionWall(downBumper)) {
                return true;
                console.log('downBumper');
            }

            return false;
        }

        var drawScore = function() {
            if (lastScore === Player.list[selfId].score) {
                return;
            }
            lastScore = Player.list[selfId].score;
            ctxUi.fillStyle = 'white';
            ctxUi.fillText(Player.list[selfId].score, 0, 30);
        }
        var lastScore = null;

        socket.on('addToChat', function(data) {
            chatList.innerHTML += '<li>' + data + '</li>';
        });

        chatForm.onsubmit = function(e) {
            e.preventDefault();
            if (chatInput.value[0] === "/") {
                socket.emit('evalServer', chatInput.value.slice(1));
            } else {
                socket.emit('sendMsgToServer', chatInput.value);
            }
            chatInput.value = '';
        };

        socket.on('evalAnwser', function(data) {
            console.log(data);
        });

        document.onkeydown = function(event) {
            if (event.keyCode === 68) {
                keyRight = true;
                socket.emit('keyPress', {
                    inputId: 'right',
                    state: true
                }); //d
            }
            if (event.keyCode === 83) {
                keyDown = true;
                socket.emit('keyPress', {
                    inputId: 'down',
                    state: true
                }); //s
            }
            if (event.keyCode === 81) {
                keyLeft = true;
                socket.emit('keyPress', {
                    inputId: 'left',
                    state: true
                }); //q
            }
            if (event.keyCode === 90) {
                keyUp = true;
                socket.emit('keyPress', {
                    inputId: 'up',
                    state: true
                }); //z
            }
        };
        document.onkeyup = function(event) {
            if (event.keyCode === 68) {
                keyRight = false;
                socket.emit('keyPress', {
                    inputId: 'right',
                    state: false
                }); //d
            }
            if (event.keyCode === 83) {
                keyDown = false;
                socket.emit('keyPress', {
                    inputId: 'down',
                    state: false
                }); //s
            }
            if (event.keyCode === 81) {
                keyLeft = false;
                socket.emit('keyPress', {
                    inputId: 'left',
                    state: false
                }); //q
            }
            if (event.keyCode === 90) {
                keyUp = false;
                socket.emit('keyPress', {
                    inputId: 'up',
                    state: false
                }); //z
            }
        };

        document.onmousedown = function(event) {
            socket.emit('keyPress', {
                inputId: 'attack',
                state: true
            });
        };

        document.onmouseup = function(event) {
            socket.emit('keyPress', {
                inputId: 'attack',
                state: false
            });
        };

        document.onmousemove = function(event) {
            var x = -250 + event.clientX - 8;
            var y = -250 + event.clientY - 8;
            var angle = Math.atan2(y, x) / Math.PI * 180;
            socket.emit('keyPress', {
                inputId: 'mouseAngle',
                state: angle
            })
        }
    </script>
</body>

</html>
